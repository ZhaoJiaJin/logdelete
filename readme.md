# 关于日志删除

当前日志删除主要利用cron（find命令+rm命令），存在一下问题：

1. 因为不同服务所在的磁盘大小不同，不同机器可以预留的日志天数不同，这样就需要为不同的服务设置不同的mtime（find命令根据文件修改时间删除日志）
2. 为了防止日志删除错误（比如删除了程序正在使用的文件），find后需要加很多个正则表达式来过滤文件，非常复杂

针对以上问题，考虑开发以下程序用于日志删除。

## 程序配置文件

改程序的配置文件只包含日志路径，比如：

```
/disk1/path/to/serviceA/logs
/disk1/path/to/serviceB/logs
/disk2/path/to/serviceC/logs
```

## 程序流程如下

1. 读取配置文件，根据配置文件分析需要监控的磁盘
2. 监控磁盘
3. 当某个磁盘（比如disk1）用量大于默认阈值（94%），将触发日志删除操作。
4. 程序根据磁盘（disk1）和配置文件找出可以删除的日志路径（/disk1/path/to/serviceA/logs和/disk1/path/to/serviceB/logs）,**会从最后修改时间最老的文件开始删除**，删除的文件满足以下标准：
   * 该文件位于配置的日志路径下，且不是文件夹
   * 该文件的last access time和last modify time大于12小时
   * 该文件没有被任何进程打开（通过检查/proc/pid/fd下的文件描述符）
5. 满足以下条件之一后，日志删除将会停止：
   * 报警磁盘容量达到85%或者以下
   * 没有可以删除的日志文件（余下的文件不满足上面的三条可删除日志标准）
6. 继续监控磁盘，回到步骤2

## 改程序和cron相比有以下优点：

1. 配置简单，只需要增加日志路径，不需要关心mtime和正则表达式。
2. 可以实现在磁盘空间允许情况下保留更多天数的日志，磁盘容量紧张时只优先保留最近12小时日志。


## build 办法
go build -o deletelog main.go

## 运行办法
./deletelog (-c config) (-d)
 * -c 表示指定配置文件
 * -d 开启debug模式（不会删除任何文件），线上启用时不要指定-d


*如果不指定config配置文件，默认使用当前目录的config文件*
